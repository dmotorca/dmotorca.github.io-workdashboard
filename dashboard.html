<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Falcon ADA Project Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      header {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }

      h1 {
        color: #333;
        margin-bottom: 10px;
      }

      .upload-section {
        margin-top: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 2px dashed #667eea;
      }

      .upload-section input {
        display: block;
        margin: 10px 0;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .stat-card h3 {
        color: #666;
        font-size: 14px;
        text-transform: uppercase;
        margin-bottom: 10px;
      }

      .stat-card .value {
        font-size: 36px;
        font-weight: bold;
        color: #667eea;
      }

      .stat-card .subvalue {
        font-size: 14px;
        color: #888;
        margin-top: 5px;
      }

      .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .chart-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .chart-card h2 {
        color: #333;
        margin-bottom: 20px;
        font-size: 18px;
      }

      .table-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
      }

      th {
        background: #f8f9fa;
        font-weight: 600;
        color: #333;
      }

      tr:hover {
        background: #f8f9fa;
      }

      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
      }

      .status-completed {
        background: #d4edda;
        color: #155724;
      }

      .status-notstarted {
        background: #f8d7da;
        color: #721c24;
      }

      .status-inprogress {
        background: #fff3cd;
        color: #856404;
      }

      .filter-section {
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
      }

      .filter-section select {
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
      }

      .no-data {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      button {
        background: #667eea;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
      }

      button:hover {
        background: #5568d3;
      }

      .line-tag {
        display: inline-block;
        padding: 2px 8px;
        margin: 2px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
      }

      .line-red {
        background: #fee;
        color: #c00;
      }
      .line-blue {
        background: #def;
        color: #05c;
      }
      .line-green {
        background: #dfd;
        color: #080;
      }
      .line-yellow {
        background: #ffd;
        color: #a90;
      }
      .line-orange {
        background: #fed;
        color: #f70;
      }
      .line-bus {
        background: #eee;
        color: #555;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>ðŸš† Falcon ADA Project Dashboard</h1>
        <p>Real-time tracking of device installations across all locations</p>

        <div class="upload-section">
          <label for="fileInput"
            ><strong>Upload Excel/CSV File to Update:</strong></label
          >
          <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" />
          <button onclick="loadDataFromCSV()">Reload Data</button>
        </div>
      </header>

      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <h3>Total Locations</h3>
          <div class="value" id="totalLocations">0</div>
        </div>
        <div class="stat-card">
          <h3>Total Devices</h3>
          <div class="value" id="totalDevices">0</div>
          <div class="subvalue" id="deviceBreakdown"></div>
        </div>
        <div class="stat-card">
          <h3>Completed</h3>
          <div class="value" id="completedLocations">0</div>
          <div class="subvalue" id="completedDevices"></div>
        </div>
        <div class="stat-card">
          <h3>Completion Rate</h3>
          <div class="value" id="completionRate">0%</div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="chart-card">
          <h2>Completion Status</h2>
          <canvas id="statusChart"></canvas>
        </div>
        <div class="chart-card">
          <h2>Installations Over Time</h2>
          <canvas id="timelineChart"></canvas>
        </div>
      </div>

      <div class="charts-grid">
        <div class="chart-card">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
            "
          >
            <h2 style="margin: 0">Devices by MAX Line</h2>
            <select
              id="lineChartFilter"
              onchange="updateLineChart()"
              style="
                padding: 8px 12px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 14px;
              "
            >
              <option value="all">All Devices</option>
              <option value="completed">Installed Devices</option>
              <option value="notstarted">Planned Installs</option>
            </select>
          </div>
          <canvas id="lineChart"></canvas>
        </div>
        <div class="chart-card">
          <h2>Monthly Install Progress</h2>
          <canvas id="monthlyChart"></canvas>
        </div>
      </div>

      <div class="table-card">
        <h2>Installation Details</h2>
        <div class="filter-section">
          <select id="statusFilter" onchange="filterTable()">
            <option value="">All Statuses</option>
            <option value="Completed">Completed</option>
            <option value="Not Started">Not Started</option>
            <option value="In Progress">In Progress</option>
          </select>
          <select id="lineFilter" onchange="filterTable()">
            <option value="">All Lines</option>
          </select>
        </div>
        <div id="tableContainer"></div>
      </div>
    </div>

    <script>
      let allData = [];
      let charts = {};

      document
        .getElementById('fileInput')
        .addEventListener('change', handleFile);

      // Auto-load data.csv on page load
      window.addEventListener('load', loadDataFromCSV);

      function loadDataFromCSV() {
        fetch('data.csv')
          .then((response) => {
            if (!response.ok) {
              throw new Error('data.csv not found');
            }
            return response.text();
          })
          .then((csvText) => {
            const rows = csvText.split('\n');
            const headers = rows[0].split(',').map((h) => h.trim());

            const data = [];
            for (let i = 1; i < rows.length; i++) {
              if (!rows[i].trim()) continue;

              const values = rows[i].split(',');
              const obj = {};
              headers.forEach((header, index) => {
                obj[header] = values[index] ? values[index].trim() : '';
              });
              data.push(obj);
            }

            processData(data);
          })
          .catch((error) => {
            console.error('Error loading data.csv:', error);
            document.getElementById('tableContainer').innerHTML =
              '<div class="no-data">No data.csv file found. Please add a data.csv file to the same folder as this HTML file, or upload a file manually.</div>';
          });
      }

      function handleFile(e) {
        const file = e.target.files[0];
        const reader = new FileReader();

        reader.onload = function (e) {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
            raw: false,
            dateNF: 'mm/dd/yy',
          });

          processData(jsonData);
        };

        reader.readAsArrayBuffer(file);
      }

      function excelDateToJSDate(excelDate) {
        if (!excelDate || excelDate === 'TBD' || isNaN(excelDate)) return null;
        // Excel date: days since 1/1/1900
        const date = new Date((excelDate - 25569) * 86400 * 1000);
        return date;
      }

      function formatDate(date) {
        if (!date) return 'TBD';
        if (typeof date === 'string' && date.includes('/')) return date;
        if (typeof date === 'number') {
          const jsDate = excelDateToJSDate(date);
          if (!jsDate) return 'TBD';
          const month = String(jsDate.getMonth() + 1).padStart(2, '0');
          const day = String(jsDate.getDate()).padStart(2, '0');
          const year = String(jsDate.getFullYear()).slice(-2);
          return `${month}/${day}/${year}`;
        }
        return date;
      }

      function processData(data) {
        allData = data;
        updateStats();
        updateCharts();
        updateTable();
        updateFilters();
      }

      function updateStats() {
        const totalLocs = allData.length;
        const totalDevs = allData.reduce(
          (sum, d) => sum + (parseInt(d['Quantity of Falcons']) || 0),
          0
        );
        const completed = allData.filter(
          (d) => d['Completion Status'] === 'Completed'
        ).length;
        const completedDevs = allData
          .filter((d) => d['Completion Status'] === 'Completed')
          .reduce(
            (sum, d) => sum + (parseInt(d['Quantity of Falcons']) || 0),
            0
          );
        const completionRate =
          totalLocs > 0 ? Math.round((completed / totalLocs) * 100) : 0;

        document.getElementById('totalLocations').textContent = totalLocs;
        document.getElementById('totalDevices').textContent = totalDevs;
        document.getElementById(
          'deviceBreakdown'
        ).textContent = `${totalLocs} locations`;
        document.getElementById('completedLocations').textContent = completed;
        document.getElementById(
          'completedDevices'
        ).textContent = `${completedDevs} devices`;
        document.getElementById('completionRate').textContent =
          completionRate + '%';
      }

      function updateCharts() {
        // Status breakdown
        const statusCounts = {};
        allData.forEach((d) => {
          const status = d['Completion Status'] || 'Unknown';
          statusCounts[status] = (statusCounts[status] || 0) + 1;
        });

        if (charts.statusChart) charts.statusChart.destroy();
        const ctx1 = document.getElementById('statusChart').getContext('2d');
        charts.statusChart = new Chart(ctx1, {
          type: 'doughnut',
          data: {
            labels: Object.keys(statusCounts),
            datasets: [
              {
                data: Object.values(statusCounts),
                backgroundColor: ['#10b981', '#ef4444', '#f59e0b', '#3b82f6'],
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { position: 'bottom' } },
          },
        });

        // Timeline
        const completedData = allData.filter(
          (d) =>
            d['Completion Status'] === 'Completed' &&
            d['Date Installed?'] &&
            d['Date Installed?'] !== 'TBD'
        );

        const dateData = {};
        completedData.forEach((d) => {
          const dateStr = formatDate(d['Date Installed?']);
          if (dateStr && dateStr !== 'TBD') {
            dateData[dateStr] =
              (dateData[dateStr] || 0) +
              parseInt(d['Quantity of Falcons'] || 1);
          }
        });

        const sortedDates = Object.keys(dateData).sort((a, b) => {
          const parseDate = (str) => {
            const [m, d, y] = str.split('/');
            return new Date(`20${y}`, m - 1, d);
          };
          return parseDate(a) - parseDate(b);
        });
        let cumulative = 0;
        const cumulativeData = sortedDates.map((date) => {
          cumulative += dateData[date];
          return cumulative;
        });

        if (charts.timelineChart) charts.timelineChart.destroy();
        const ctx2 = document.getElementById('timelineChart').getContext('2d');
        charts.timelineChart = new Chart(ctx2, {
          type: 'line',
          data: {
            labels: sortedDates,
            datasets: [
              {
                label: 'Cumulative Devices',
                data: cumulativeData,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } },
          },
        });

        // Lines breakdown
        updateLineChart();

        // Monthly progress
        const monthlyData = {};
        completedData.forEach((d) => {
          const dateStr = formatDate(d['Date Installed?']);
          if (dateStr && dateStr !== 'TBD') {
            const [m, day, y] = dateStr.split('/');
            const monthKey = `20${y}-${m.padStart(2, '0')}`;
            monthlyData[monthKey] =
              (monthlyData[monthKey] || 0) +
              parseInt(d['Quantity of Falcons'] || 1);
          }
        });

        const sortedMonths = Object.keys(monthlyData).sort();

        if (charts.monthlyChart) charts.monthlyChart.destroy();
        const ctx4 = document.getElementById('monthlyChart').getContext('2d');
        charts.monthlyChart = new Chart(ctx4, {
          type: 'bar',
          data: {
            labels: sortedMonths.map((m) => {
              const [year, month] = m.split('-');
              return `${month}/${year}`;
            }),
            datasets: [
              {
                label: 'Devices Installed',
                data: sortedMonths.map((m) => monthlyData[m]),
                backgroundColor: '#10b981',
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } },
          },
        });
      }

      function updateLineChart() {
        const filterValue = document.getElementById('lineChartFilter').value;

        let filteredData = allData;
        let chartColor = '#667eea';
        let chartLabel = 'All Devices';

        if (filterValue === 'completed') {
          filteredData = allData.filter(
            (d) => d['Completion Status'] === 'Completed'
          );
          chartColor = '#10b981';
          chartLabel = 'Installed Devices';
        } else if (filterValue === 'notstarted') {
          filteredData = allData.filter(
            (d) => d['Completion Status'] === 'Not Started'
          );
          chartColor = '#ef4444';
          chartLabel = 'Planned Installs';
        }

        const lineCounts = {};
        filteredData.forEach((d) => {
          const lines = (d['MAX Lines'] || '').split(',');
          lines.forEach((line) => {
            const trimmed = line.trim();
            if (trimmed) {
              lineCounts[trimmed] =
                (lineCounts[trimmed] || 0) +
                parseInt(d['Quantity of Falcons'] || 0);
            }
          });
        });

        if (charts.lineChart) charts.lineChart.destroy();
        const ctx3 = document.getElementById('lineChart').getContext('2d');
        charts.lineChart = new Chart(ctx3, {
          type: 'bar',
          data: {
            labels: Object.keys(lineCounts),
            datasets: [
              {
                label: chartLabel,
                data: Object.values(lineCounts),
                backgroundColor: chartColor,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } },
          },
        });
      }

      function formatLines(linesStr) {
        if (!linesStr) return '';
        const lines = linesStr.split(',');
        return lines
          .map((line) => {
            const trimmed = line.trim();
            const className = trimmed.toLowerCase().replace(/\s+/g, '-');
            return `<span class="line-tag line-${className}">${trimmed}</span>`;
          })
          .join(' ');
      }

      function updateTable() {
        const container = document.getElementById('tableContainer');

        if (allData.length === 0) {
          container.innerHTML =
            '<div class="no-data">No data available. Please upload a file or load sample data.</div>';
          return;
        }

        let html = '<table><thead><tr>';
        html += '<th>Stop ID</th>';
        html += '<th>Location Name</th>';
        html += '<th>Status</th>';
        html += '<th>Devices</th>';
        html += '<th>MAX Lines</th>';
        html += '<th>Date Installed</th>';
        html += '</tr></thead><tbody>';

        const statusFilter = document.getElementById('statusFilter').value;
        const lineFilter = document.getElementById('lineFilter').value;

        const filteredData = allData.filter((d) => {
          if (statusFilter && d['Completion Status'] !== statusFilter)
            return false;
          if (lineFilter && !(d['MAX Lines'] || '').includes(lineFilter))
            return false;
          return true;
        });

        filteredData.forEach((d) => {
          const status = d['Completion Status'] || 'Unknown';
          const statusClass = status.toLowerCase().replace(/\s+/g, '');

          html += '<tr>';
          html += `<td>${d['Stop ID'] || 'N/A'}</td>`;
          html += `<td>${d['Location Name'] || 'N/A'}</td>`;
          html += `<td><span class="status-badge status-${statusClass}">${status}</span></td>`;
          html += `<td>${d['Quantity of Falcons'] || 0}</td>`;
          html += `<td>${formatLines(d['MAX Lines'])}</td>`;
          html += `<td>${formatDate(d['Date Installed?'])}</td>`;
          html += '</tr>';
        });

        html += '</tbody></table>';
        container.innerHTML = html;
      }

      function updateFilters() {
        const allLines = new Set();
        allData.forEach((d) => {
          const lines = (d['MAX Lines'] || '').split(',');
          lines.forEach((line) => {
            const trimmed = line.trim();
            if (trimmed) allLines.add(trimmed);
          });
        });

        const lineFilter = document.getElementById('lineFilter');
        lineFilter.innerHTML = '<option value="">All Lines</option>';
        [...allLines].sort().forEach((line) => {
          lineFilter.innerHTML += `<option value="${line}">${line}</option>`;
        });
      }

      function filterTable() {
        updateTable();
      }
    </script>
  </body>
</html>
