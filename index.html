<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Falcon ADA Project Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      header {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }

      h1 {
        color: #333;
        margin-bottom: 10px;
      }

      .last-updated {
        color: #666;
        font-size: 14px;
        margin-top: 10px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .stat-card h3 {
        color: #666;
        font-size: 14px;
        text-transform: uppercase;
        margin-bottom: 10px;
      }

      .stat-card .value {
        font-size: 36px;
        font-weight: bold;
        color: #667eea;
      }

      .stat-card .subvalue {
        font-size: 14px;
        color: #888;
        margin-top: 5px;
      }

      .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .chart-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .chart-card h2 {
        color: #333;
        margin-bottom: 20px;
        font-size: 18px;
      }

      .table-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
      }

      th {
        background: #f8f9fa;
        font-weight: 600;
        color: #333;
      }

      tr:hover {
        background: #f8f9fa;
      }

      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
      }

      .status-completed {
        background: #d4edda;
        color: #155724;
      }

      .status-notstarted {
        background: #f8d7da;
        color: #721c24;
      }

      .status-inprogress {
        background: #fff3cd;
        color: #856404;
      }

      .filter-section {
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
      }

      .filter-section select {
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
      }

      .no-data {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
      }

      .line-tag {
        display: inline-block;
        padding: 2px 8px;
        margin: 2px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
      }

      .line-red {
        background: #fee;
        color: #c00;
      }
      .line-blue {
        background: #def;
        color: #05c;
      }
      .line-green {
        background: #dfd;
        color: #080;
      }
      .line-yellow {
        background: #ffd;
        color: #a90;
      }
      .line-orange {
        background: #fed;
        color: #f70;
      }
      .line-bus {
        background: #eee;
        color: #555;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>ðŸš† Falcon ADA Project Dashboard</h1>
        <p>Real-time tracking of device installations across all locations</p>
        <div class="last-updated" id="lastUpdated">Loading data...</div>
      </header>

      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <h3>Total Locations</h3>
          <div class="value" id="totalLocations">-</div>
        </div>
        <div class="stat-card">
          <h3>Total Devices</h3>
          <div class="value" id="totalDevices">-</div>
          <div class="subvalue" id="deviceBreakdown"></div>
        </div>
        <div class="stat-card">
          <h3>Completed</h3>
          <div class="value" id="completedLocations">-</div>
          <div class="subvalue" id="completedDevices"></div>
        </div>
        <div class="stat-card">
          <h3>Completion Rate</h3>
          <div class="value" id="completionRate">-%</div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="chart-card">
          <h2>Completion Status</h2>
          <canvas id="statusChart"></canvas>
        </div>
        <div class="chart-card">
          <h2>Installations Over Time</h2>
          <canvas id="timelineChart"></canvas>
        </div>
      </div>

      <div class="charts-grid">
        <div class="chart-card">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
            "
          >
            <h2 style="margin: 0">Devices by MAX Line</h2>
            <select
              id="lineChartFilter"
              onchange="updateLineChart()"
              style="
                padding: 8px 12px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 14px;
              "
            >
              <option value="all">All Devices</option>
              <option value="completed">Installed Devices</option>
              <option value="notstarted">Planned Installs</option>
            </select>
          </div>
          <canvas id="lineChart"></canvas>
        </div>
        <div class="chart-card">
          <h2>Monthly Install Progress</h2>
          <canvas id="monthlyChart"></canvas>
        </div>
      </div>

      <div class="table-card">
        <h2>Installation Details</h2>
        <div class="filter-section">
          <select id="statusFilter" onchange="filterTable()">
            <option value="">All Statuses</option>
            <option value="Completed">Completed</option>
            <option value="Not Started">Not Started</option>
            <option value="In Progress">In Progress</option>
          </select>
          <select id="lineFilter" onchange="filterTable()">
            <option value="">All Lines</option>
          </select>
        </div>
        <div id="tableContainer"></div>
      </div>
    </div>

    <script>
      let allData = [];
      let charts = {};

      // Auto-load data.csv on page load
      window.addEventListener('load', loadDataFromCSV);

      function loadDataFromCSV() {
        fetch('data.csv')
          .then((response) => {
            if (!response.ok) {
              throw new Error('Could not load data.csv');
            }
            return response.text();
          })
          .then((csvText) => {
            const data = parseCSV(csvText);
            if (data && data.length > 0) {
              processData(data);
              document.getElementById(
                'lastUpdated'
              ).textContent = `Last updated: ${new Date().toLocaleString()}`;
            } else {
              showError('No data found in data.csv');
            }
          })
          .catch((error) => {
            showError(
              'Error loading data.csv: ' +
                error.message +
                '. Make sure data.csv is in the same folder as index.html'
            );
            console.error('Load error:', error);
          });
      }

      function parseCSV(csvText) {
        const lines = csvText.split('\n').filter((line) => line.trim());
        if (lines.length < 2) return [];

        const headers = parseCSVLine(lines[0]);
        const data = [];

        for (let i = 1; i < lines.length; i++) {
          const values = parseCSVLine(lines[i]);
          if (values.length === 0) continue;

          const row = {};
          headers.forEach((header, index) => {
            row[header] = values[index] || '';
          });
          data.push(row);
        }

        return data;
      }

      function parseCSVLine(line) {
        const result = [];
        let current = '';
        let insideQuotes = false;

        for (let i = 0; i < line.length; i++) {
          const char = line[i];

          if (char === '"') {
            insideQuotes = !insideQuotes;
          } else if (char === ',' && !insideQuotes) {
            result.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }

        result.push(current.trim());
        return result;
      }

      function showError(message) {
        document.getElementById(
          'lastUpdated'
        ).innerHTML = `<div class="error-message">${message}</div>`;
      }

      function parseDate(dateStr) {
        if (!dateStr || dateStr === 'TBD' || dateStr.trim() === '') return null;

        // Handle MM/DD/YY format
        const parts = dateStr.trim().split('/');
        if (parts.length === 3) {
          let [month, day, year] = parts;
          month = parseInt(month);
          day = parseInt(day);
          year = parseInt(year);

          // Convert 2-digit year to 4-digit
          if (year < 100) {
            year = year < 50 ? 2000 + year : 1900 + year;
          }

          return new Date(year, month - 1, day);
        }

        return null;
      }

      function formatDate(dateStr) {
        if (!dateStr || dateStr === 'TBD' || dateStr.trim() === '')
          return 'TBD';

        const date = parseDate(dateStr);
        if (!date || isNaN(date.getTime())) return dateStr;

        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const year = String(date.getFullYear()).slice(-2);

        return `${month}/${day}/${year}`;
      }

      function processData(data) {
        // Clean and validate data
        allData = data
          .filter((row) => {
            return row['Stop ID'] && row['Location Name'];
          })
          .map((row) => {
            return {
              'Stop ID': String(row['Stop ID']).trim(),
              'Location Name': String(row['Location Name']).trim(),
              'Completion Status': String(
                row['Completion Status'] || ''
              ).trim(),
              'Quantity of Falcons': parseInt(row['Quantity of Falcons']) || 0,
              'MAX Lines': String(row['MAX Lines'] || '').trim(),
              'Date Installed?': String(row['Date Installed?'] || '').trim(),
            };
          });

        updateStats();
        updateCharts();
        updateTable();
        updateFilters();
      }

      function updateStats() {
        const totalLocs = allData.length;
        const totalDevs = allData.reduce(
          (sum, d) => sum + d['Quantity of Falcons'],
          0
        );
        const completed = allData.filter(
          (d) => d['Completion Status'] === 'Completed'
        ).length;
        const completedDevs = allData
          .filter((d) => d['Completion Status'] === 'Completed')
          .reduce((sum, d) => sum + d['Quantity of Falcons'], 0);
        const completionRate =
          totalLocs > 0 ? Math.round((completed / totalLocs) * 100) : 0;

        document.getElementById('totalLocations').textContent = totalLocs;
        document.getElementById('totalDevices').textContent = totalDevs;
        document.getElementById(
          'deviceBreakdown'
        ).textContent = `${totalLocs} locations`;
        document.getElementById('completedLocations').textContent = completed;
        document.getElementById(
          'completedDevices'
        ).textContent = `${completedDevs} devices`;
        document.getElementById('completionRate').textContent =
          completionRate + '%';
      }

      function updateCharts() {
        updateStatusChart();
        updateTimelineChart();
        updateLineChart();
        updateMonthlyChart();
      }

      function updateStatusChart() {
        const statusCounts = {};
        allData.forEach((d) => {
          const status = d['Completion Status'] || 'Unknown';
          statusCounts[status] = (statusCounts[status] || 0) + 1;
        });

        if (charts.statusChart) charts.statusChart.destroy();

        const ctx = document.getElementById('statusChart').getContext('2d');
        charts.statusChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: Object.keys(statusCounts),
            datasets: [
              {
                data: Object.values(statusCounts),
                backgroundColor: ['#10b981', '#ef4444', '#f59e0b', '#3b82f6'],
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                position: 'bottom',
              },
            },
          },
        });
      }

      function updateTimelineChart() {
        // Get completed installations with valid dates
        const completedData = allData.filter((d) => {
          if (d['Completion Status'] !== 'Completed') return false;
          const dateStr = d['Date Installed?'];
          if (!dateStr || dateStr === 'TBD') return false;
          const date = parseDate(dateStr);
          return date && !isNaN(date.getTime());
        });

        // Group by date
        const dateMap = new Map();
        completedData.forEach((d) => {
          const dateStr = formatDate(d['Date Installed?']);
          const current = dateMap.get(dateStr) || 0;
          dateMap.set(dateStr, current + d['Quantity of Falcons']);
        });

        // Sort dates chronologically
        const sortedDates = Array.from(dateMap.keys()).sort((a, b) => {
          const dateA = parseDate(a);
          const dateB = parseDate(b);
          return dateA - dateB;
        });

        // Calculate cumulative
        let cumulative = 0;
        const cumulativeData = sortedDates.map((date) => {
          cumulative += dateMap.get(date);
          return cumulative;
        });

        if (charts.timelineChart) charts.timelineChart.destroy();

        const ctx = document.getElementById('timelineChart').getContext('2d');
        charts.timelineChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: sortedDates,
            datasets: [
              {
                label: 'Cumulative Devices',
                data: cumulativeData,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  precision: 0,
                },
              },
            },
          },
        });
      }

      function updateLineChart() {
        const filterValue = document.getElementById('lineChartFilter').value;

        let filteredData = allData;
        let chartColor = '#667eea';
        let chartLabel = 'All Devices';

        if (filterValue === 'completed') {
          filteredData = allData.filter(
            (d) => d['Completion Status'] === 'Completed'
          );
          chartColor = '#10b981';
          chartLabel = 'Installed Devices';
        } else if (filterValue === 'notstarted') {
          filteredData = allData.filter(
            (d) => d['Completion Status'] === 'Not Started'
          );
          chartColor = '#ef4444';
          chartLabel = 'Planned Installs';
        }

        // Count devices per line
        const lineCounts = new Map();
        filteredData.forEach((d) => {
          const linesStr = d['MAX Lines'];
          if (!linesStr) return;

          // Split by comma and clean each line
          const lines = linesStr
            .split(',')
            .map((line) => line.trim())
            .filter((line) => line.length > 0);

          lines.forEach((line) => {
            const current = lineCounts.get(line) || 0;
            lineCounts.set(line, current + d['Quantity of Falcons']);
          });
        });

        // Sort lines for consistent display
        const sortedLines = Array.from(lineCounts.keys()).sort();
        const counts = sortedLines.map((line) => lineCounts.get(line));

        if (charts.lineChart) charts.lineChart.destroy();

        const ctx = document.getElementById('lineChart').getContext('2d');
        charts.lineChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: sortedLines,
            datasets: [
              {
                label: chartLabel,
                data: counts,
                backgroundColor: chartColor,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  precision: 0,
                },
              },
            },
          },
        });
      }

      function updateMonthlyChart() {
        // Get completed installations with valid dates
        const completedData = allData.filter((d) => {
          if (d['Completion Status'] !== 'Completed') return false;
          const dateStr = d['Date Installed?'];
          if (!dateStr || dateStr === 'TBD') return false;
          const date = parseDate(dateStr);
          return date && !isNaN(date.getTime());
        });

        // Group by month
        const monthMap = new Map();
        completedData.forEach((d) => {
          const date = parseDate(d['Date Installed?']);
          if (!date) return;

          const year = date.getFullYear();
          const month = date.getMonth() + 1;
          const monthKey = `${year}-${String(month).padStart(2, '0')}`;

          const current = monthMap.get(monthKey) || 0;
          monthMap.set(monthKey, current + d['Quantity of Falcons']);
        });

        // Sort months chronologically
        const sortedMonths = Array.from(monthMap.keys()).sort();
        const counts = sortedMonths.map((month) => monthMap.get(month));

        // Format labels as "Mon YYYY"
        const labels = sortedMonths.map((monthKey) => {
          const [year, month] = monthKey.split('-');
          const date = new Date(year, parseInt(month) - 1, 1);
          return date.toLocaleDateString('en-US', {
            month: 'short',
            year: 'numeric',
          });
        });

        if (charts.monthlyChart) charts.monthlyChart.destroy();

        const ctx = document.getElementById('monthlyChart').getContext('2d');
        charts.monthlyChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'Devices Installed',
                data: counts,
                backgroundColor: '#10b981',
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  precision: 0,
                },
              },
            },
          },
        });
      }

      function formatLines(linesStr) {
        if (!linesStr) return '';

        const lines = linesStr
          .split(',')
          .map((line) => line.trim())
          .filter((line) => line.length > 0);

        return lines
          .map((line) => {
            const className = line.toLowerCase().replace(/\s+/g, '-');
            return `<span class="line-tag line-${className}">${line}</span>`;
          })
          .join(' ');
      }

      function updateTable() {
        const container = document.getElementById('tableContainer');

        if (allData.length === 0) {
          container.innerHTML = '<div class="no-data">No data available.</div>';
          return;
        }

        const statusFilter = document.getElementById('statusFilter').value;
        const lineFilter = document.getElementById('lineFilter').value;

        const filteredData = allData.filter((d) => {
          if (statusFilter && d['Completion Status'] !== statusFilter)
            return false;
          if (lineFilter && !d['MAX Lines'].includes(lineFilter)) return false;
          return true;
        });

        let html = '<table><thead><tr>';
        html += '<th>Stop ID</th>';
        html += '<th>Location Name</th>';
        html += '<th>Status</th>';
        html += '<th>Devices</th>';
        html += '<th>MAX Lines</th>';
        html += '<th>Date Installed</th>';
        html += '</tr></thead><tbody>';

        filteredData.forEach((d) => {
          const status = d['Completion Status'] || 'Unknown';
          const statusClass = status.toLowerCase().replace(/\s+/g, '');

          html += '<tr>';
          html += `<td>${d['Stop ID']}</td>`;
          html += `<td>${d['Location Name']}</td>`;
          html += `<td><span class="status-badge status-${statusClass}">${status}</span></td>`;
          html += `<td>${d['Quantity of Falcons']}</td>`;
          html += `<td>${formatLines(d['MAX Lines'])}</td>`;
          html += `<td>${formatDate(d['Date Installed?'])}</td>`;
          html += '</tr>';
        });

        html += '</tbody></table>';
        container.innerHTML = html;
      }

      function updateFilters() {
        // Get all unique lines
        const allLines = new Set();
        allData.forEach((d) => {
          const linesStr = d['MAX Lines'];
          if (!linesStr) return;

          const lines = linesStr
            .split(',')
            .map((line) => line.trim())
            .filter((line) => line.length > 0);
          lines.forEach((line) => allLines.add(line));
        });

        const lineFilter = document.getElementById('lineFilter');
        lineFilter.innerHTML = '<option value="">All Lines</option>';

        Array.from(allLines)
          .sort()
          .forEach((line) => {
            lineFilter.innerHTML += `<option value="${line}">${line}</option>`;
          });
      }

      function filterTable() {
        updateTable();
      }
    </script>
  </body>
</html>
